# 경로 선택 알고리즘 — 왜 “가까워 보이는 전주”가 아닌 “위쪽 전주”가 선택되는가

이 문서는 설계 결과에서 **눈으로 보기엔 가까운 왼쪽 전주** 대신 **위쪽 전주(고압 3상)**가 “최적 경로”로 나오는 이유를, 실제 코드의 탐색·선별·순위 로직에 맞춰 설명합니다.

---

## 1. 전체 흐름 요약

선택은 **한 번의 거리 비교**로 이루어지지 않고, 아래 단계를 **순서대로** 거칩니다.

1. **후보 전주 선별** (Phase Matching + 거리 + 우선순위)
2. **도로 그래프에의 연결** (도로 접근성)
3. **도로 네트워크 위 경로 탐색** (A*)
4. **전선 교차 검증** (FR-05)
5. **공사비 환산 점수(cost_index) 기준 최종 순위**

“가까운 왼쪽 전주”는 **1~4 단계 중 한 곳에서** 후보에서 빠지거나, **5단계**에서 점수가 더 나빠서 2번 이후로 밀릴 수 있습니다.

---

## 2. 후보 전주 선별 (Target Selector)

**파일**: `app/core/target_selector.py`

### 2.1 Phase Matching (상 조건 필터)

- **단상 설계**  
  - 고압/저압 **전선이 한 개라도 연결된** 전주만 후보.
  - 전선 연결이 없으면 아예 후보에서 제외.
- **3상 설계**  
  - **고압 3상** 선로에 연결된 전주만 후보.

따라서 **눈에 가깝더라도** “저압선만 연결”이거나 “연결 전선 정보가 없는” 전주는 이 단계에서 탈락합니다.

### 2.2 거리·Fast Track

- 수용가와의 **직선 거리**가 **400m 초과**인 전주는 제외.
- **50m 이내**이고, 그 직선상에 **건물이 없으면** Fast Track 후보가 됨.

### 2.3 우선순위 (같은 Phase를 통과한 전주들만)

단상일 때:

- **저압선 연결** 전주: `priority - 100` → 가장 우선 탐색.
- **고압만 연결** 전주: `priority + 50` → 뒤로 밀림.

정렬 기준은 `(priority, 직선거리)` 오름차순이라, **저압선 연결**이고 **가까운** 전주가 먼저 탐색됩니다.

→ “가까운 왼쪽 전주”가 **고압만 연결**이면, 같은 거리라도 우선순위가 낮아져서 나중에 탐색됩니다.

---

## 3. 도로 그래프 연결 (Graph Builder)

**파일**: `app/core/graph_builder.py`

후보로 남은 전주라도 **도로 네트워크와 이어져야** 경로 탐색 대상이 됩니다.

- 수용가·전주는 **가장 가까운 도로**까지의 거리로 “도로 접근성”을 봄.
- 이 거리가 **ROAD_ACCESS_DISTANCE(기본 100m)를 넘으면**  
  → 해당 전주는 **그래프에 넣지 않고** 제거 (`_add_pole_nodes` 참고).

즉, **직선으로는 가깝지만**  
- 도로에서 100m 넘게 떨어진 전주는  
**경로 탐색 단계에서 아예 대상이 아닙니다.**  
“가까운 왼쪽 전주”가 골목/空地 한가운데라면, 여기서 탈락할 수 있습니다.

---

## 4. 경로 탐색 (Pathfinder, A*)

**파일**: `app/core/pathfinder.py`

- **Fast Track**: 50m 이내·장애물 없으면 “직선 연결” 1개를 우선 넣음.
- 나머지 후보 전주에 대해:
  - **도로 그래프만** 사용해 **A*** 로 **수용가 → 전주** 최단 경로를 찾습니다.
  - “직선 거리”가 아니라 **도로 링크를 따라 간 거리·가중치 합**으로 비교합니다.

가중치 예시 (엣지별):

- `weight = 거리(m) + (거리 / 40) × (전주단가/100)`  
  → 거리가 길수록, 그리고 **전주를 많이 세울수록** 경로의 총 가중치가 커짐.

정렬 기준:

- 먼저 **`total_weight`** 오름차순으로 경로를 정렬하고,
- 상위 N개만 다음 단계(전선 교차 검사·공사비 계산)로 넘깁니다.

따라서 **직선으로는 멀어 보여도**,  
- 도로를 따라가면 오히려 짧고,  
- 신설 전주 수가 적은  
경로가 **위쪽 전주**로 나올 수 있습니다.

---

## 5. 전선 교차 검증 (FR-05)

**파일**: `app/core/design_engine.py` (경로 검증 로직)

- **신설 경로**가 **기존 고압·저압 전선**과 **교차(Cross)**하면 해당 경로는 **무조건 제거**.
- “가까운 왼쪽 전주”로 가는 경로가 **기존 전선을 가로질러야** 하면,  
  아무리 거리가 짧아도 **유효 후보에서 제외**됩니다.

---

## 6. 최종 순위 — cost_index (공사비 환산 점수)

**파일**: `app/core/cost_calculator.py`

남은 경로에 대해 **공사비 환산 점수**를 계산합니다.

```
cost_index = (신설 전주 수 × 10,000) + (총 거리 × 1) + (굴절 수 × 50)
```

- **전주 수**가 점수에 가장 크게 반영 (1개당 10,000점).
- 그다음 **거리**, 마지막으로 **굴절 수**.
- **cost_index가 작을수록** 1순위(최적 경로), 2순위, … 가 됩니다.

그래서:

- “가까운 왼쪽 전주”로 가는 경로가  
  - 신설 전주가 더 많거나  
  - 도로 거리가 더 길거나  
  - 굴절이 많으면  
- **위쪽 전주**로 가는 경로보다 **cost_index**가 커져서  
  → **위쪽 전주 경로가 1순위**로 선택될 수 있습니다.

---

## 7. 이 좌표(대흥4길 인근)에서의 해석

화면에서:

- **선택된 경로**: 수용가 → **위쪽 기설전주(고압 3상)** · 신설 전주 3개, 73.0m.
- **의심 대상**: 수용가 **왼쪽**에 보이는, 더 가까워 보이는 전주.

아래 중 **하나 이상**이 만족되면, 알고리즘 상 “위쪽 전주”가 나오는 것이 맞습니다.

1. **Phase / 전선 연결**  
   왼쪽 전주는  
   - 단상 설계에서 쓰는 “저압선 연결”이 아니거나,  
   - 전선 연결 정보가 없어 Phase Matching에서 탈락했을 수 있음.

2. **도로 접근성**  
   왼쪽 전주가 도로에서 100m 초과로 떨어져  
   - 도로 그래프에 연결되지 않았고,  
   - 따라서 A* 탐색 대상이 아예 아닐 수 있음.

3. **도로 경로**  
   왼쪽 전주까지는 **도로를 따라가면** 오히려 거리·굴절이 커서  
   - `total_weight`가 위쪽 전주 경로보다 커졌을 수 있음.

4. **전선 교차**  
   왼쪽 전주로 가는 경로가 **기존 전선과 교차**해  
   - FR-05 위반으로 후보에서 제거되었을 수 있음.

5. **비용 점수**  
   왼쪽 전주로 가는 경로는 유효했더라도  
   - 신설 전주 수·거리·굴절 조합으로 **cost_index**가 더 커서  
   - 2순위 이하로 밀리고, 1순위는 위쪽 전주로 결정되었을 수 있음.

---

## 8. 참고 코드 위치

| 내용 | 파일 | 참고 위치 |
|------|------|-----------|
| Phase Matching, 우선순위 | `app/core/target_selector.py` | `select()`, `_phase_matching()`, 단상 시 `has_lv` / `has_hv` 처리 |
| 도로 접근성, 전주 연결 | `app/core/graph_builder.py` | `_add_pole_nodes()`, `_connect_point_to_road()`, ROAD_ACCESS_DISTANCE |
| A* 경로 탐색, 가중치 정렬 | `app/core/pathfinder.py` | `find_paths()`, `_astar_path()`, `total_weight` 정렬 |
| 전선 교차 검증 | `app/core/design_engine.py` | 경로 검증 후 `pathfinding_result.paths` 필터링 |
| cost_index·순위 | `app/core/cost_calculator.py` | `_calculate_cost_index()`, `calculate_batch()` |

---

**요약**: “가까운 왼쪽 전주”가 안 나오는 이유는,  
**직선 거리 하나**로 결정되는 것이 아니라  
**(1) 상·전선 조건, (2) 도로 접근성, (3) 도로 경로 길이·전주 수·굴절, (4) 전선 교차, (5) cost_index**  
까지 포함된 **탐색·선별·순위 알고리즘 전체**의 결과이기 때문입니다.
