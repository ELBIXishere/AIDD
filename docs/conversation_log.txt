================================================================================
ELBIX AIDD 개발 대화 기록
================================================================================
기간: 2026-01-26
주제: AI 기반 배전 설계 자동화 시스템 개발 및 디버깅

================================================================================
[대화 1] 설계 처리 오류 확인 요청
================================================================================

사용자:
설계처리에 오류가 났어 확인해봐

조치:
- API 서버 실행 여부 확인
- curl 명령어로 API 테스트
- API 경로 수정 (/api/v1 prefix 추가)

--------------------------------------------------------------------------------

사용자:
1. 시설물 로드도 안되고
2. 테스트 좌표에서도 설계 처리 중 오류가 발생했습니다 로그가 뜨네

[이미지 첨부: 시설물 로드 오류 화면]

조치:
- 서버 시작 (uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload)
- API 엔드포인트 경로 확인 및 수정
- DesignEngine.run() 메서드 호출 방식 수정

================================================================================
[대화 2] 전주 선택 로직 문제
================================================================================

사용자:
이 이미지를 보면 기설전주가 근처에 많은데도 고압 3상 기설전주에만 붙여서 
로직이 안맞아. 필요한 로직을 다시 검증하고 설계한 다음에 어떤 로직을 
쓰는게 맞는지 생각해보고 적용하자

[이미지 첨부: 단상 설계 시 먼 고압 3상 전주 선택 문제]

분석:
- 수용가 좌표: X=14242397.12, Y=4437571.28
- 문제: 단상 설계임에도 가까운 저압 전주가 아닌 먼 고압 3상 전주 선택

조치:
1. target_selector.py 수정
   - _analyze_pole_connections() 메서드 추가
   - 우선순위 로직 개선:
     * 단상: 저압선 연결 전주 우선 (priority -= 100)
     * 3상: 고압 3상선 연결 전주 우선 (priority -= 100)

--------------------------------------------------------------------------------

사용자:
이 좌표계에서 왜 이 전주가 선택됐는지 로직을 설명하고 이게 옳은지 아닌지 분석해봐.

분석 결과:
- 로직은 정상 적용됨
- 그러나 _analyze_pole_connections()에서 저압선(LV) 연결이 0개로 분석됨
- 원인: 저압선 데이터 자체가 없음

--------------------------------------------------------------------------------

사용자:
원인 확인해봐. 데이터베이스 구조를 너가 확인해보는 것도 괜찮을듯

데이터 분석:
- 주 전선 레이어(AI_FAC_002.GIS_PTH): 고압선만 존재
- 변압기 레이어(AI_FAC_003.GIS_PTH): 저압선 정보 포함
  * TEXT_GIS_ANNXN 필드에 "OW 22 x 3" 형태로 저장
  * "OW" = Outdoor Wire (옥외용 비닐절연전선) = 저압선

--------------------------------------------------------------------------------

사용자:
근본 원인 해결.

조치 (3개 파일 수정):

1. wfs_client.py
   - get_all_data()에 transformers 레이어 추가

2. preprocessor.py
   - _extract_lv_lines_from_transformers() 메서드 추가
   - TEXT_GIS_ANNXN에서 "OW" 포함 시 저압선으로 분류
   - _link_lines_to_poles() max_distance 10m → 15m 확대

3. target_selector.py
   - 기존 우선순위 로직 유지 (이미 수정됨)

결과:
- 개선 전: 경로 156.9m, 신설 전주 7개, 비용 11,649,000원
- 개선 후: 경로 25.3m, 신설 전주 0개, 비용 926,500원

================================================================================
[대화 3] 경로 탐색 로직 설명 요청
================================================================================

사용자:
내 로직에 대한 궁금함이야. 이건 사실 신설전주가 2개만 있고 대각선으로 
연결해도 되는거 아니야? 이렇게 되어있는 이유라도 있나? @ref_docs 이거까지 
참고해서 설명 좀 해줘

설명:
1. 도로 기반 경로 탐색
   - 배전 설계에서 전선은 도로를 따라 설치해야 함
   - 대각선 연결 불가 (사유지 통과, 시공/유지보수 어려움)

2. 현재 시스템 구조
   - graph_builder.py: 도로 중심선을 NetworkX 그래프로 변환
   - pathfinder.py: A* 알고리즘으로 도로 기반 최단 경로 탐색

3. ref_docs 참조
   - FR-02: 외선 공사 설계 (최대 400m)
   - FR-03: 최대 2개 후보 경로 생성
   - FR-04: 건물/철도/하천 회피
   - FR-05: 기존 전선 교차 불가

================================================================================
[대화 4] 3상 설계 불가 원인 분석
================================================================================

사용자:
[이미지 첨부: 3상 설계 실패 화면]
좌표: X=14242499.62, Y=4437631.79
오류: "경로 없음 - 조건에 맞는 경로를 찾을 수 없습니다"

해당 좌표에서 3상 설계가 안되는 이유를 설명해줘

분석 실행:
```
=== 데이터 현황 ===
전주: 34개
전선: 40개 (고압 7개, 저압 33개)
3상 고압선: 7개

=== 3상 후보 전주: 7개 ===
52400176: 거리=118.2m, HV=True, HV_3상=True
7317500: 거리=122.2m, HV=True, HV_3상=True
...
```

설계 실행 로그:
```
Phase 5: 경로 탐색 중... → 5개 유효 경로
Phase 5.5: 전선 교차 검증 중...

경로 제외 (전선 교차): 52400178 - LV_52400203(LV)
경로 제외 (전선 교차): 52400176 - 52400167(HV)
경로 제외 (전선 교차): 7317500 - 52400167(HV)
경로 제외 (전선 교차): 315329975 - 52400167(HV), LV_22595262(LV), LV_315329979(LV)
경로 제외 (전선 교차): 7317498 - 52400167(HV), LV_315329979(LV)

=== 3상 설계 결과 ===
상태: NO_ROUTE
오류: 모든 경로가 기존 전선과 교차하여 유효한 경로가 없습니다
```

결론:
- 3상 후보 전주는 7개 있음
- 경로도 5개 탐색됨
- 그러나 모든 경로가 기존 전선(고압/저압)과 교차하여 전부 탈락
- 해당 위치는 기존 전선으로 둘러싸여 있어 3상 전주까지 전선 교차 없이 
  도달 불가능 → 지리적 제약으로 설계 불가

해결 방안:
1. 수용가 위치 변경
2. 교차하는 전선의 전주에서 분기
3. 단상 설계로 변경
4. 지중화 (비용 증가)

================================================================================
[대화 5] 개발 보고서 작성
================================================================================

사용자:
개발 보고서를 작성해줘.
경로 탐색 로직은 반드시 있어야 해.
너와 내가 나눈 대화를 기반으로 개발 빌드업 보고서의 형태.
10,000자 이내

작성 완료:
- 파일: /root/elbix_aidd/docs/development_report.md
- 내용:
  1. 프로젝트 개요
  2. 시스템 아키텍처 (9단계 파이프라인)
  3. 경로 탐색 로직 (A* 알고리즘 상세)
  4. 후보 전주 선별 로직 (Phase Matching)
  5. 전선 교차 검증 (FR-05)
  6. 문제 해결 과정 (저압선 누락, 3상 설계 실패)
  7. 설계 제약조건
  8. 성과 및 결론

================================================================================
[대화 6] 대화 기록 추출
================================================================================

사용자:
우리 둘이 나눈 대화를 텍스트파일로 뽑아서 @docs 안에 넣어줘.

→ 현재 이 파일 작성

================================================================================
수정된 파일 목록
================================================================================

1. app/core/target_selector.py
   - _analyze_pole_connections() 메서드 추가
   - select() 메서드 우선순위 로직 개선

2. app/core/wfs_client.py
   - get_all_data()에 transformers 레이어 추가

3. app/core/preprocessor.py
   - _extract_lv_lines_from_transformers() 메서드 추가
   - process() 메서드에 저압선 추출 로직 통합
   - _link_lines_to_poles() max_distance 15m로 확대

================================================================================
핵심 성과
================================================================================

1. 저압선 데이터 통합
   - 변압기 레이어에서 저압선 추출 로직 구현
   - TEXT_GIS_ANNXN 필드 파싱 ("OW" → 저압선)

2. 전주 선택 로직 최적화
   - 단상: 저압선 연결 전주 우선
   - 3상: 고압 3상선 연결 전주 우선

3. 비용 절감 효과
   - 테스트 케이스 기준 92% 비용 절감 (11.6M → 0.9M)
   - 신설 전주 7개 → 0개

================================================================================
END OF CONVERSATION LOG
================================================================================
