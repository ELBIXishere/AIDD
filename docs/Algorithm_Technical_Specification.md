# 알고리즘 기술 정의서 (Algorithm Technical Specification)
## 대규모 배전 설계 시스템 — 경로 탐색 및 그래프 구축

---

## 1. 도로 네트워크 모델링 (Graph Construction)

### 1.1 GIS 데이터를 노드·엣지로 변환하는 방식

도로 중심선(GIS 라인)은 **선형(LineString) 좌표열**로 주어짐. 각 도로에 대해 **연속된 두 꼭짓점을 잇는 선분**을 하나의 **엣지(Edge)**로 두고, 선분의 **시작점·끝점**을 **노드(Node)**로 둠.

- **노드 구분**: 서로 다른 도로가 같은 위치에서 만나거나, 한 도로가 꺾일 때마다 **좌표가 동일한지 여부**로 노드를 통합함. 두 점 사이 거리가 **허용 오차(기본 1m) 이내**이면 **동일 노드**로 간주하고, 기존 노드를 재사용함.
- **공간 인덱스**: 노드 생성·조회 시 **R-tree** 또는 **격자(Grid) 기반 해시**를 사용하여, “가장 가까운 기존 노드” 탐색을 **로그 또는 상수 시간**에 수행함. 좌표 정밀도(예: 1m) 단위로 격자 키를 만들어 동일·인접 격자만 검사함.
- **엣지 속성**: 각 엣지에는 **실거리(미터)**와 **가중치(비용 반영)**가 부여되며, 형상(LineString)은 보존함. 엣지 유형은 **도로 본선**, **스냅 연결**, **수용가/전주 연결** 등으로 구분됨.

따라서 GIS 도로 중심선은 **가중 무방향 그래프**의 노드·엣지로 변환되며, **끊어진 도로**와 **교차점**은 아래 로직으로 보정·처리함.

### 1.2 끊어진 도로 연결(Snapping) 및 교차점 처리

**끊어진 도로 연결(Snapping)**  
- **차수(Degree)가 1인 노드**, 즉 **한쪽 끝만 도로와 연결된 끝점**만 대상으로 함.
- 끝점 쌍에 대해 **직선 거리**를 계산하고, **스냅 허용 거리(기본 10m) 이내**이면 **새 엣지**를 추가하여 두 끝점을 연결함.
- 이미 연결된 쌍은 중복으로 연결하지 않음.  
이를 통해 **데이터 상에서 끊어 보이던 도로**를 하나의 네트워크로 이어, 경로 탐색이 가능하게 함.

**교차점 처리**  
- 서로 다른 도로가 **같은 위치(또는 1m 이내)**에서 만나면, **동일 노드**로 합침(위 노드 통합 규칙).
- 한 도로가 **꺾이는 지점**은 **연속된 두 선분**이 **같은 끝점을 공유**하는 구조이므로, 별도 “교차점” 연산 없이 **기존 노드 재사용**으로 처리됨.

**수용가·전주를 도로에 연결**  
- 수용가 위치 및 후보 전주 위치는 **점(Point)**임.
- **모든 도로 엣지**에 대해, 해당 점에서 **도로 형상(LineString) 위의 최근접점**을 구함.
- **최근접점까지의 거리**가 **도로 접근 허용 거리(기본 100m)를 초과**하면, 해당 수용가/전주는 **도로 네트워크에 연결하지 않고** 제외함.
- 연결 시:
  - 최근접점이 **기존 노드와 1m 이내**이면, **해당 노드에 직접 연결**하는 엣지만 추가함.
  - 그렇지 않으면 **도로 위에 새 연접점(Junction) 노드**를 만들고, **기존 도로 엣지를 그 연접점 기준으로 둘로 쪼갠 뒤**, 수용가/전주에서 연접점까지 **연결 엣지**를 추가함.

결과적으로, **도로 중심선 → 노드·엣지 변환**, **끊긴 도로 스냅**, **수용가/전주–도로 연결**이 순차 적용되어 **탐색 가능한 도로 네트워크 그래프**가 완성됨.

---

## 2. 경로 탐색 알고리즘 (Pathfinding Core)

### 2.1 적용된 핵심 알고리즘

- **주 알고리즘**: **A\***. 출발(수용가)–목표(후보 전주) 간 **가중치 합이 최소인 경로**를 구하는 데 사용함.
- **휴리스틱**: **유클리드 거리(2차원 평면)**. 현재 노드와 목표 노드 좌표로 계산하며, **목표별로 캐시**하여 재사용함.
- **가중치**: 엣지에 부여된 **비용(가중치) 값**을 사용함. **거리만이 아니라 전주 비용이 반영된 합성 비용**임(아래 산정 공식).
- **폴백**: **A\*** 사용 불가 시 **Dijkstra**로 동일 그래프·동일 가중치에 대해 최단 경로를 구함.
- **조기 종료**: **A\***로 경로를 따라 **누적 거리**를 계산하다가 **최대 허용 거리(기본 400m)를 초과**하면, 해당 목표 전주는 **도달 불가**로 간주하고 탐색을 중단함.

**Fast Track**  
- 수용가와 후보 전주 간 **직선 거리가 50m 이내**이고, **그 직선상에 장애물(건물)이 없으면** **도로 그래프를 타지 않고** **수용가–전주 직선 연결**을 유효 경로로 둠. 이 경우 **별도 경로 탐색 없이** 직선을 최종 경로 후보로 사용함.

### 2.2 가중치(Cost) 산정 공식

엣지 비용(가중치)은 **단순 거리가 아니라**, **거리**와 **전주 설치 비용에 상응하는 항**을 더한 값으로 둠.

**공식 (개념)**  
- **제1항 — 거리**:  
  **가중치 = (엣지 거리, m) × 거리 가중치**  
  거리 가중치 기본값은 **1**이라서, 이 항은 **엣지 길이(m)**와 동일함.
- **제2항 — 전주 비용 반영**:  
  배전 설계 기준상 **경간당 전주 간격(기본 40m)**을 가정함. 즉, **40m당 전주 1본**이 필요하다고 보며,  
  **가중치 += (엣지 거리 / 전주 간격) × (전주 단가 / 100)**  
  로, **거리에 비례한 전주 비용**을 가중치에 반영함.  
  예: 전주 간격 40m, 전주 단가 50만 원이면, **40m당 5,000**이 추가되어, **m당 125**가 비용에 더해짐.

**정리**  
- **엣지 가중치 = (거리 × 1) + (거리 / 40) × (전주단가 / 100)**  
- 따라서 **거리가 길수록**, 그리고 **전주 단가·간격에 따라** 가중치가 커짐.  
경로 탐색 시 **가중치 합이 작은 경로**를 선택하므로, **단순히 짧은 것**뿐 아니라 **전주 수를 줄이는 방향**도 반영됨.

**경로 단위 비용**  
- 각 경로에 대해 **경로 상 모든 엣지의 가중치를 합산**한 값을 **총 가중치**로 사용함.
- 이 **총 가중치**로 **여러 후보 경로를 비교·정렬**하며, **상위 N개(기본 10개)**만 유지함.

---

## 3. 제약 조건 처리 (Constraints Handling)

### 3.1 절대 금지 구간: 전선 교차(FR-05)

**규칙**: **신설 경로는 기존 고압·저압 전선과 교차하면 안 됨.**

- **적용 시점**: **경로 탐색이 끝난 뒤**, 도출된 **각 경로 후보**에 대해 **사후 검증**으로 적용함.
- **방식**:  
  - 신설 경로를 **연속 좌표열 → LineString**으로 만들고,  
  - **기존 전선(전부)**의 LineString과 **교차(Intersect)** 여부를 검사함.  
  - **단순 접촉(Touch)**만 있는 경우(예: 전주와의 연결점)는 **허용**하고, **교차(Cross)** 또는 **내부 교차**에 해당하는 경우만 **금지**로 봄.
- **연결점 예외**: 교차가 **경로의 시작점 또는 끝점**에서만 발생하는 경우(전주와의 접속)는 **연결점**으로 간주하여 **제외**함. 이때 **위치 일치 판정**은 **1m 이내**로 함.
- **결과**: **교차가 한 건이라도 발견된 경로**는 **유효 후보에서 제거**하고, **교차가 없는 경로만** 이후 전주 배치·비용 계산·순위 산정에 사용함. **모든 후보가 교차 시**에는 **유효 경로 없음**으로 처리함.

### 3.2 건물 회피 및 도로 이격

**건물 내부 전주 제거**  
- 전처리 단계에서 **건물 폴리곤**을 합친 뒤, **전주 위치**가 **건물 내부**에 있으면 **해당 전주를 후보에서 제거**함.  
- **도로 위 전주**는 장애물이 아니므로 **제거하지 않음**.

**Fast Track 시 장애물(건물)**  
- **50m 이내 직선 연결(Fast Track)** 여부를 판단할 때, **수용가–전주 직선**이 **어떤 건물과 교차**하는지 검사함.  
- **교차(Intersect) 있음 & 접촉(Touch)만 있는 경우 아님**이면 **장애물 있음**으로 보고, **Fast Track 불가**로 함.  
- 이 경우 **도로 그래프를 이용한 경로 탐색**으로 넘어감.

**도로 이격(접근성)**  
- **수용가** 및 **후보 전주**가 **도로에서 너무 멀리** 있으면 **도로 네트워크에 연결되지 않음**(§1.2).  
- **도로 접근 허용 거리(기본 100m)**를 초과하면 **해당 점은 그래프에 포함되지 않으므로**, 경로 탐색 대상에서 **사전에 제외**됨.

**건물 우회 경로**  
- **인입 구간에 건물이 있을 경우 최대 2회 굴절로 우회**하는 로직이 **그래프 빌더에 정의**되어 있으나, **현재 설계 흐름에서는 수용가/전주–도로 연결 단계에 사용되지 않음**.  
- 따라서 **“건물 회피”**는 **전주 제거**, **Fast Track 장애물 판정**, **도로 이격** 수준으로만 적용되고, **우회 경로 생성**은 **미적용** 상태임.

---

## 4. 최적 결과 선별 (Optimization & Ranking)

### 4.1 경로 후보의 수축 과정

- **경로 탐색**: 수용가 → 후보 전주별로 **A\*(또는 Dijkstra)**로 **가중치 최소 경로**를 구함.  
  **직선 거리 가까운 전주부터** 탐색하며, **최대 거리(400m) 초과** 시 해당 전주는 제외함.
- **다중 경로**: **여러 후보 전주**에 대해 각각 **최단 가중치 경로**를 구한 뒤, **총 가중치 오름차순**으로 정렬하고 **상위 N개(기본 10개)**만 남김.
- **전선 교차 검증**: 위 N개에 대해 **FR-05(전선 교차 금지)**를 적용하여 **교차 없는 경로만** 남김.
- **전주 배치·비용 계산**: 남은 **각 경로**에 대해 **신설 전주 배치** 및 **공사비·비용 지표**를 산출함.

### 4.2 최종 순위 산정: 공사비 환산 점수(Cost Index)

**공식**  
**Score = N_poles × W_pole + D × W_dist + N_turns × W_turn**

- **N_poles**: 해당 경로에 배치된 **신설 전주 수**
- **D**: **총 거리(m)**
- **N_turns**: **굴절 횟수**(경로가 꺾이는 지점의 개수)
- **W_pole**: 전주 가중치(기본 **10,000**)
- **W_dist**: 거리 가중치(기본 **1**, m당)
- **W_turn**: 굴절 가중치(기본 **50**, 회당)

**의미**  
- **전주 수**가 순위에 **가장 크게** 반영됨. **전주 1본 차이 = 10,000점 차이**.
- **같은 전주 수**면 **거리가 짧을수록**, **같은 거리**면 **굴절이 적을수록** 유리함.
- **점수가 낮을수록** 더 좋은 경로로 간주함.

**순위 부여**  
- **모든 유효 경로**에 대해 **공사비 환산 점수**를 계산한 뒤, **오름차순 정렬**함.
- 정렬된 순서대로 **1등, 2등, …** 순위를 매기고, **최종 결과**는 이 순위대로 제시함.

### 4.3 전주 배치·굴절과의 연계

- **전주 배치**:  
  - **수용가 위치에 첫 전주**를 두고, **경간(기본 40m)**마다 전주를 배치함.  
  - **기설 전주로부터 15m 이내**에는 신설 전주를 두지 않음.  
  - **분기점(꺾이는 지점)**은 **굴절각이 임계값(기본 150°) 미만**인 곳으로 정의하고, **분기점마다 전주를 반드시 배치**함.
- **굴절 횟수**: **분기점 개수**를 **굴절 횟수**로 셈. 이 값이 **N_turns**로 **공사비 환산 점수**에 들어감.

따라서 **비용·거리·시공 용이성(전주 수, 굴절)**이 **공사비 환산 점수** 하나로 통합되고, **해당 점수 기준 정렬**로 **최종 경로 순위**가 정해짐.

---

*문서 버전: 1.0 | 대상: ELBIX AIDD 배전 설계 시스템 (경로 탐색 및 그래프 구축)*
